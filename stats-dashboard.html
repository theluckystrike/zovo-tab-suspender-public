<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tab Suspender Pro - Statistics Dashboard</title>
    <link rel="stylesheet" href="settings.css">
    <style>
        /* Dashboard-specific styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
        }

        .dashboard-card .card-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dashboard-card .card-label {
            font-size: 13px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 30px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
        }

        .chart-period {
            display: flex;
            gap: 8px;
        }

        .period-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-btn.active,
        .period-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .chart-canvas {
            width: 100%;
            height: 250px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 20px 0;
        }

        .chart-bar {
            flex: 1;
            background: var(--accent-gradient);
            border-radius: 4px 4px 0 0;
            min-height: 20px;
            position: relative;
            transition: all 0.3s ease;
        }

        .chart-bar:hover {
            opacity: 0.8;
        }

        .chart-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: var(--text-tertiary);
            white-space: nowrap;
        }

        .sites-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .sites-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .sites-card h3 {
            font-size: 16px;
            margin-bottom: 16px;
        }

        .site-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .site-item:last-child {
            border-bottom: none;
        }

        .site-domain {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .site-count {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-secondary);
        }

        .focus-stats {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .focus-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .focus-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(124, 58, 237, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-secondary);
        }

        .focus-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .focus-stat {
            text-align: center;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .focus-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-secondary);
            margin-bottom: 4px;
        }

        .focus-stat-label {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
        }

        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .sites-section {
                grid-template-columns: 1fr;
            }
        }

        /* ========== AGENT 2: DASHBOARD SYNC STYLES ========== */
        .stats-sync-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
        }

        .stats-sync-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stats-sync-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .stats-sync-indicator.syncing {
            color: var(--accent-primary);
        }

        .stats-sync-indicator .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }

        .stats-sync-indicator.syncing .sync-dot {
            background: var(--accent-primary);
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .stats-last-updated {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .stats-refresh-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .stats-refresh-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .stats-refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-refresh-btn.syncing svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* ========== END AGENT 2 ========== */
    </style>
</head>

<body>
    <div class="settings-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <img src="icons/icon48.png" alt="Tab Suspender Pro" class="logo-icon">
                    <div class="logo-text">
                        <h1>Statistics Dashboard</h1>
                        <span class="tagline">Your memory savings at a glance</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-outline" id="exportBtn">Export Data</button>
                    <button class="btn btn-outline" id="resetBtn">Reset Stats</button>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="main">
            <div style="max-width: 1200px; margin: 0 auto;">
                <!-- ========== AGENT 2: DASHBOARD SYNC UI ========== -->
                <div class="stats-sync-bar" id="stats-sync-bar">
                    <div class="stats-sync-info">
                        <div class="stats-sync-indicator" id="stats-sync-status">
                            <span class="sync-dot"></span>
                            <span class="sync-text">Live</span>
                        </div>
                        <div class="stats-last-updated" id="stats-last-updated">
                            Last updated: Just now
                        </div>
                    </div>
                    <button class="stats-refresh-btn" id="stats-refresh-btn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6"></path>
                            <path d="M1 20v-6h6"></path>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                            <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
                <!-- ========== END AGENT 2 ========== -->

                <!-- Overview Cards -->
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-value" id="totalSaved">0 GB</div>
                        <div class="card-label">Total Memory Saved</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-value" id="tabsSuspended">0</div>
                        <div class="card-label">Tabs Suspended</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-value" id="todaySaved">0 MB</div>
                        <div class="card-label">Saved Today</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-value" id="avgDaily">0 MB</div>
                        <div class="card-label">Daily Average</div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h2 class="chart-title">Memory Savings Over Time</h2>
                        <div class="chart-period">
                            <button class="period-btn active" data-period="7">7 Days</button>
                            <button class="period-btn" data-period="30">30 Days</button>
                        </div>
                    </div>
                    <div class="chart-canvas" id="chartCanvas">
                        <!-- Bars will be rendered by JavaScript -->
                    </div>
                </div>

                <!-- Sites and Focus -->
                <div class="sites-section">
                    <!-- Top Sites -->
                    <div class="sites-card">
                        <h3>Most Suspended Sites</h3>
                        <div id="topSites">
                            <!-- Sites will be rendered by JavaScript -->
                            <div class="site-item">
                                <span class="site-domain">Loading...</span>
                                <span class="site-count">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Focus Mode Stats -->
                    <div class="focus-stats">
                        <div class="focus-header">
                            <div class="focus-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </div>
                            <div>
                                <h3 style="margin-bottom:2px">Focus Mode</h3>
                                <span style="font-size: 12px; color: var(--text-tertiary)">Pomodoro-style focus
                                    sessions</span>
                            </div>
                        </div>
                        <div class="focus-grid">
                            <div class="focus-stat">
                                <div class="focus-stat-value" id="focusSessions">0</div>
                                <div class="focus-stat-label">Sessions</div>
                            </div>
                            <div class="focus-stat">
                                <div class="focus-stat-value" id="focusTime">0h</div>
                                <div class="focus-stat-label">Total Time</div>
                            </div>
                            <div class="focus-stat">
                                <div class="focus-stat-value" id="focusWeek">0</div>
                                <div class="focus-stat-label">This Week</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <a href="https://zovo.one" target="_blank" class="footer-link">
                    Powered by <strong>Zovo</strong>
                </a>
                <a href="settings.html" class="footer-link">‚Üê Back to Settings</a>
            </div>
        </footer>
    </div>

    <script>
        // DOM Elements
        const totalSaved = document.getElementById('totalSaved');
        const tabsSuspended = document.getElementById('tabsSuspended');
        const todaySaved = document.getElementById('todaySaved');
        const avgDaily = document.getElementById('avgDaily');
        const chartCanvas = document.getElementById('chartCanvas');
        const topSites = document.getElementById('topSites');
        const focusSessions = document.getElementById('focusSessions');
        const focusTime = document.getElementById('focusTime');
        const focusWeek = document.getElementById('focusWeek');
        const exportBtn = document.getElementById('exportBtn');
        const resetBtn = document.getElementById('resetBtn');

        // ========== AGENT 2: DASHBOARD SYNC ELEMENTS ==========
        const syncStatusEl = document.getElementById('stats-sync-status');
        const lastUpdatedEl = document.getElementById('stats-last-updated');
        const refreshBtn = document.getElementById('stats-refresh-btn');

        let lastUpdateTimestamp = null;
        let dashboardSyncEnabled = true;
        // ========== END AGENT 2 ==========

        let currentPeriod = 7;
        let lastUpdatedInterval = null; // Track interval for cleanup

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // ========== AGENT 2: DASHBOARD SYNC INIT ==========
            await checkDashboardSyncFeature();
            if (dashboardSyncEnabled) {
                setupStatsListener();
                setupRefreshButton();
                startLastUpdatedTimer();
            }
            // ========== END AGENT 2 ==========

            await loadStats();
            setupEventListeners();
        });

        // ========== AGENT 2: DASHBOARD SYNC FUNCTIONS ==========

        /**
         * Check if dashboard sync feature is enabled
         */
        async function checkDashboardSyncFeature() {
            try {
                const result = await chrome.storage.local.get('feature_flags_override');
                const overrides = result.feature_flags_override || {};
                dashboardSyncEnabled = overrides.DASHBOARD_SYNC !== false; // Default: enabled

                if (!dashboardSyncEnabled) {
                    // Hide sync bar if feature disabled
                    const syncBar = document.getElementById('stats-sync-bar');
                    if (syncBar) syncBar.style.display = 'none';
                }
            } catch (error) {
                console.log('[DashboardSync] Feature check error:', error);
            }
        }

        /**
         * Listen for STATS_UPDATED broadcasts from background
         */
        function setupStatsListener() {
            chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
                if (message.type === 'STATS_UPDATED') {
                    console.log('[DashboardSync] Received STATS_UPDATED');
                    handleStatsUpdate(message.stats, message.timestamp);
                    sendResponse({ received: true });
                }
                return false;
            });
            console.log('[DashboardSync] Listener setup complete');
        }

        /**
         * Handle incoming stats update
         */
        function handleStatsUpdate(stats, timestamp) {
            lastUpdateTimestamp = timestamp || Date.now();

            // Update sync status to show "Live"
            updateSyncStatus(false);
            updateLastUpdatedDisplay();

            // Update the stats display
            updateStatsDisplay(stats);

            // Also refresh chart and top sites
            loadChartData(currentPeriod);
            loadTopSites();
        }

        /**
         * Update stats display with new data
         */
        function updateStatsDisplay(stats) {
            if (!stats) return;

            totalSaved.textContent = formatBytes(stats.totalSaved || 0);
            tabsSuspended.textContent = stats.lifetimeTabsSuspended || 0;
            todaySaved.textContent = formatBytes(stats.todaySaved || 0);

            // Calculate daily average
            chrome.storage.local.get(['installDate']).then(result => {
                const installDate = result.installDate || Date.now();
                const days = Math.max(1, Math.ceil((Date.now() - installDate) / (24 * 60 * 60 * 1000)));
                const avg = (stats.totalSaved || 0) / days;
                avgDaily.textContent = formatBytes(avg);
            });
        }

        /**
         * Setup manual refresh button
         */
        function setupRefreshButton() {
            if (!refreshBtn) return;

            refreshBtn.addEventListener('click', async () => {
                await manualRefresh();
            });
        }

        /**
         * Manually refresh stats
         */
        async function manualRefresh() {
            updateSyncStatus(true); // Show syncing
            refreshBtn.disabled = true;
            refreshBtn.classList.add('syncing');

            try {
                // Request fresh stats
                const response = await chrome.runtime.sendMessage({ type: 'REQUEST_STATS_SYNC' });

                if (response && response.stats) {
                    handleStatsUpdate(response.stats, Date.now());
                } else {
                    // Fallback to regular GET_STATS
                    await loadStats();
                }
            } catch (error) {
                console.error('[DashboardSync] Refresh failed:', error);
                // Fallback to regular load
                await loadStats();
            } finally {
                updateSyncStatus(false);
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('syncing');
            }
        }

        /**
         * Update sync status indicator
         */
        function updateSyncStatus(isSyncing) {
            if (!syncStatusEl) return;

            const syncText = syncStatusEl.querySelector('.sync-text');

            if (isSyncing) {
                syncStatusEl.classList.add('syncing');
                if (syncText) syncText.textContent = 'Syncing...';
            } else {
                syncStatusEl.classList.remove('syncing');
                if (syncText) syncText.textContent = 'Live';
            }
        }

        /**
         * Update "Last updated" display
         */
        function updateLastUpdatedDisplay() {
            if (!lastUpdatedEl || !lastUpdateTimestamp) return;

            const text = formatLastUpdated(lastUpdateTimestamp);
            lastUpdatedEl.textContent = `Last updated: ${text}`;
        }

        /**
         * Format timestamp as human-readable "X ago"
         */
        function formatLastUpdated(timestamp) {
            if (!timestamp) return 'Never';

            const seconds = Math.floor((Date.now() - timestamp) / 1000);

            if (seconds < 5) return 'Just now';
            if (seconds < 60) return `${seconds}s ago`;

            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;

            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;

            return new Date(timestamp).toLocaleDateString();
        }

        /**
         * Start timer to update "Last updated" display
         */
        function startLastUpdatedTimer() {
            // Clear any existing interval first
            if (lastUpdatedInterval) {
                clearInterval(lastUpdatedInterval);
            }
            // Update every 10 seconds
            lastUpdatedInterval = setInterval(() => {
                updateLastUpdatedDisplay();
            }, 10000);
        }

        // Clean up interval when page unloads to prevent memory leaks
        window.addEventListener('beforeunload', () => {
            if (lastUpdatedInterval) {
                clearInterval(lastUpdatedInterval);
            }
        });
        // ========== END AGENT 2 ==========

        async function loadStats() {
            try {
                const response = await chrome.runtime.sendMessage({ type: 'GET_STATS' });

                // Update overview cards
                totalSaved.textContent = formatBytes(response.totalSaved || 0);
                tabsSuspended.textContent = response.lifetimeTabsSuspended || 0;
                todaySaved.textContent = formatBytes(response.todaySaved || 0);

                // Calculate daily average
                const result = await chrome.storage.local.get(['memoryStats', 'installDate']);
                const installDate = result.installDate || Date.now();
                const days = Math.max(1, Math.ceil((Date.now() - installDate) / (24 * 60 * 60 * 1000)));
                const avg = (response.totalSaved || 0) / days;
                avgDaily.textContent = formatBytes(avg);

                // Load chart data
                await loadChartData(currentPeriod);

                // Load top sites
                await loadTopSites();

                // Load focus stats
                await loadFocusStats();

                // ========== AGENT 2: DASHBOARD SYNC ==========
                // Update last updated timestamp on initial load
                if (dashboardSyncEnabled) {
                    lastUpdateTimestamp = Date.now();
                    updateLastUpdatedDisplay();
                }
                // ========== END AGENT 2 ==========
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadChartData(days) {
            try {
                const result = await chrome.storage.local.get('memoryStats');
                const history = result.memoryStats?.history || [];

                // Group by date using UTC (prevents DST issues and year collision)
                const byDay = {};
                for (let i = 0; i < days; i++) {
                    const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
                    // Use UTC to avoid DST issues
                    const key = `${date.getUTCFullYear()}-${date.getUTCMonth() + 1}-${date.getUTCDate()}`;
                    byDay[key] = 0;
                }

                const cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
                history.filter(h => h.timestamp > cutoff).forEach(h => {
                    const date = new Date(h.timestamp);
                    // Use UTC to avoid DST issues
                    const key = `${date.getUTCFullYear()}-${date.getUTCMonth() + 1}-${date.getUTCDate()}`;
                    if (byDay[key] !== undefined) {
                        byDay[key] += h.memorySaved || 0;
                    }
                });

                // Render chart
                const entries = Object.entries(byDay).reverse();
                const maxValue = Math.max(...entries.map(([, v]) => v), 1);

                chartCanvas.innerHTML = entries.map(([label, value]) => {
                    const height = Math.max(20, (value / maxValue) * 200);
                    // Format label as user-friendly date (e.g., "Jan 15" instead of "2025-1-15")
                    const formattedLabel = formatChartLabel(label);
                    return `
            <div class="chart-bar" style="height: ${height}px" title="${formatBytes(value)}">
              <span class="chart-bar-label">${formattedLabel}</span>
            </div>
          `;
                }).join('');
            } catch (error) {
                console.error('Failed to load chart data:', error);
            }
        }

        async function loadTopSites() {
            try {
                const result = await chrome.storage.local.get('memoryStats');
                const history = result.memoryStats?.history || [];

                // Count by domain
                const byDomain = {};
                history.forEach(h => {
                    try {
                        const domain = new URL(h.url).hostname;
                        byDomain[domain] = (byDomain[domain] || 0) + 1;
                    } catch (e) { }
                });

                // Sort by count (descending), then alphabetically for tie-breaking
                const sorted = Object.entries(byDomain)
                    .sort((a, b) => {
                        if (b[1] !== a[1]) return b[1] - a[1]; // Primary: by count descending
                        return a[0].localeCompare(b[0]); // Secondary: alphabetical for ties
                    })
                    .slice(0, 5);

                if (sorted.length === 0) {
                    topSites.innerHTML = '<p style="color: var(--text-tertiary); text-align: center; padding: 20px;">No data yet</p>';
                    return;
                }

                topSites.innerHTML = sorted.map(([domain, count]) => `
          <div class="site-item">
            <span class="site-domain">${domain}</span>
            <span class="site-count">${count}x</span>
          </div>
        `).join('');
            } catch (error) {
                console.error('Failed to load top sites:', error);
            }
        }

        async function loadFocusStats() {
            try {
                const result = await chrome.storage.local.get('focusSessions');
                const sessions = result.focusSessions || [];

                focusSessions.textContent = sessions.length;

                const totalMs = sessions.reduce((sum, s) => sum + (s.duration || 0), 0);
                const totalMinutes = Math.floor(totalMs / (60 * 1000));
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;

                // Show hours and minutes (e.g., "2h 30m" or "45m" or "0m")
                if (hours > 0 && minutes > 0) {
                    focusTime.textContent = `${hours}h ${minutes}m`;
                } else if (hours > 0) {
                    focusTime.textContent = `${hours}h`;
                } else {
                    focusTime.textContent = `${minutes}m`;
                }

                const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
                const thisWeek = sessions.filter(s => s.timestamp > weekAgo).length;
                focusWeek.textContent = thisWeek;
            } catch (error) {
                console.error('Failed to load focus stats:', error);
            }
        }

        function setupEventListeners() {
            // Period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentPeriod = parseInt(btn.dataset.period);
                    await loadChartData(currentPeriod);
                });
            });

            // Export
            exportBtn.addEventListener('click', async () => {
                const result = await chrome.storage.local.get(['memoryStats', 'focusSessions', 'installDate']);
                const data = JSON.stringify(result, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tab-suspender-stats.json';
                a.click();
                URL.revokeObjectURL(url);
            });

            // Reset - clear all stats data completely
            resetBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to reset all statistics? This cannot be undone.')) {
                    // Clear all stats-related data
                    await chrome.storage.local.remove([
                        'memoryStats',
                        'focusSessions',
                        'installDate'
                    ]);

                    // Reset memoryStats to empty instead of just removing
                    await chrome.storage.local.set({
                        memoryStats: { totalSaved: 0, tabsSuspended: 0, history: [] },
                        installDate: Date.now()
                    });

                    location.reload();
                }
            });
        }

        function formatBytes(bytes) {
            // Validate input to prevent NaN/crashes
            if (bytes === null || bytes === undefined || isNaN(bytes) || bytes < 0) {
                return '0 B';
            }
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
            const i = Math.min(Math.floor(Math.log(bytes) / Math.log(k)), sizes.length - 1);
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Format chart labels as user-friendly dates (e.g., "Jan 15" instead of "2025-1-15")
        function formatChartLabel(dateKey) {
            try {
                // Parse the key format "YYYY-M-D"
                const parts = dateKey.split('-');
                if (parts.length !== 3) return dateKey;

                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1; // JavaScript months are 0-indexed
                const day = parseInt(parts[2]);

                // Use UTC to avoid DST issues
                const date = new Date(Date.UTC(year, month, day));

                // Format as "Jan 15" or "15" depending on space
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${months[date.getUTCMonth()]} ${date.getUTCDate()}`;
            } catch {
                return dateKey;
            }
        }

        // Get date key using UTC to avoid DST issues
        function getDateKey(timestamp) {
            const date = new Date(timestamp);
            return `${date.getUTCFullYear()}-${date.getUTCMonth() + 1}-${date.getUTCDate()}`;
        }
    </script>
</body>

</html>